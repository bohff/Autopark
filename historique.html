<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autopark - Historique</title>
    <link rel="stylesheet" href="./css/global.css">
    <link rel="stylesheet" href="./css/forms.css">
    <link rel="stylesheet" href="./css/historique.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB0x46slqtPOs21EXI_eSnhvC5LvXksJns&v=weekly"></script>
</head>
<body>
    
    <div id="formContainer" class="form-container-large">
        <h1 data-i18n="history.title">Historique des trajets</h1>
        
        <div id="historiqueMap"></div>
        
        <div id="historiqueList">
            <h3 data-i18n="history.list">Liste des trajets :</h3>
            <div id="trajetsContainer"></div>
        </div>
        
        <p class="text-center">
            <a href="index.html" class="btn-back-home">
                <i class="fas fa-home"></i>
                <span data-i18n="auth.backHome">Retour √† l'accueil</span>
            </a>
        </p>
    </div>
    
    <script src="./js/lang.js"></script>
    <script src="./js/auth.js"></script>
    <script src="./js/header.js"></script>
    <script src="./js/footer.js"></script>
    <script>
        if (!isLoggedIn()) window.location.href = 'connexion.html';
        
        async function loadHistorique() {
            const mapContainer = document.getElementById('historiqueMap');
            const listContainer = document.getElementById('trajetsContainer');
            const currentLang = localStorage.getItem('autopark_lang') || 'fr';
            const locale = currentLang === 'en' ? 'en-GB' : 'fr-FR';
            
            try {
                const trajets = await getHistorique();
                trajets.sort((a, b) => new Date(b.date_trajet) - new Date(a.date_trajet));
                
                if (trajets.length === 0) {
                    listContainer.innerHTML = `<p class="text-grey" data-i18n="history.empty">${t('history.empty')}</p>`;
                } else {
                    let html = '<ul>';
                    trajets.forEach(trajet => {
                        const dateObj = new Date(trajet.date_trajet);
                        const dateStr = dateObj.toLocaleDateString(locale) + ' ' + dateObj.toLocaleTimeString(locale, {hour: '2-digit', minute:'2-digit'});
                        
                        // J'ai aussi d√©plac√© le style inline dans historique.css
                        html += `<li>
                            <strong>${trajet.destination_nom || t('history.unknown')}</strong><br>
                            <small class="history-date">üìÖ ${dateStr} | ‚è±Ô∏è ${trajet.duree} | üìè ${trajet.distance} m</small><br>
                            <small class="history-location">üìç ${trajet.origine || t('history.unknown')}</small>
                        </li>`;
                    });
                    html += '</ul>';
                    listContainer.innerHTML = html;
                }
                
                const map = new google.maps.Map(mapContainer, {
                    zoom: 12, center: { lat: 49.1193, lng: 6.1757 }, 
                    mapTypeControl: false, streetViewControl: false, fullscreenControl: false
                });
                const bounds = new google.maps.LatLngBounds();
                const compteurVisites = {};
                
                trajets.forEach(trajet => {
                    const nom = trajet.destination_nom;
                    compteurVisites[nom] = (compteurVisites[nom] || 0) + 1;
                });
                
                const parkingsAffiches = [];
                trajets.forEach(trajet => {
                    if (parkingsAffiches.includes(trajet.destination_nom)) return;
                    parkingsAffiches.push(trajet.destination_nom);
                    
                    const position = { lat: trajet.destination_lat, lng: trajet.destination_lng };
                    const visites = compteurVisites[trajet.destination_nom];
                    const wordVisits = t('history.visits');
                    
                    const marker = new google.maps.Marker({
                        position: position, map: map, title: trajet.destination_nom
                    });
                    
                    const infoWindow = new google.maps.InfoWindow({
                        content: `<div style="color:#333;"><strong>${trajet.destination_nom}</strong><br>${visites} ${wordVisits}</div>`
                    });
                    marker.addListener('click', () => infoWindow.open(map, marker));
                    bounds.extend(position);
                });
                if (trajets.length > 0) map.fitBounds(bounds);
            
            } catch (error) {
                console.error('Erreur chargement historique:', error);
                mapContainer.innerHTML = `<p class="error text-center" style="padding:50px;" data-i18n="error.history_fetch">${t('error.history_fetch')}</p>`;
                listContainer.innerHTML = '';
            }
        }
        loadHistorique();
    </script>
</body>
</html>