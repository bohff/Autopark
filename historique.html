<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autopark - Historique</title>
    <link rel="stylesheet" href="./css/global.css">
    <link rel="stylesheet" href="./css/forms.css">
    <link rel="stylesheet" href="./css/historique.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB0x46slqtPOs21EXI_eSnhvC5LvXksJns&v=weekly"></script>
</head>
<body>
    
    <div id="formContainer" style="max-width: 900px;">
        <h1 data-i18n="history.title">Historique des trajets</h1>
        
        <div id="historiqueMap" style="width: 100%; height: 400px; border-radius: 8px; margin-bottom: 20px;"></div>
        
        <div id="historiqueList" style="margin-bottom: 20px;">
            <h3 data-i18n="history.list">Liste des trajets :</h3>
            <div id="trajetsContainer"></div>
        </div>
        
        <p style="text-align: center; margin-top: 20px;">
            <a href="index.html" data-i18n="auth.backHome">Retour √† l'accueil</a>
        </p>
    </div>
    
    <script src="./js/lang.js"></script>
    <script src="./js/auth.js"></script>
    <script src="./js/header.js"></script>
    <script src="./js/footer.js"></script>
    <script>
        // 1. S√©curit√© r√©activ√©e : Redirection si pas connect√©
        if (!isLoggedIn()) {
            window.location.href = 'connexion.html';
        }
        
        async function loadHistorique() {
            const mapContainer = document.getElementById('historiqueMap');
            const listContainer = document.getElementById('trajetsContainer');
            
            // R√©cup√©rer la langue actuelle pour le format de date
            const currentLang = localStorage.getItem('autopark_lang') || 'fr';
            const locale = currentLang === 'en' ? 'en-GB' : 'fr-FR';
            
            try {
                const trajets = await getHistorique();
                
                // Tri par date d√©croissante (plus r√©cent en premier)
                trajets.sort((a, b) => new Date(b.date_trajet) - new Date(a.date_trajet));
                
                if (trajets.length === 0) {
                    // Message "Aucun trajet" traduit
                    listContainer.innerHTML = `<p style="color:#666;" data-i18n="history.empty">${t('history.empty')}</p>`;
                } else {
                    let html = '<ul style="list-style: none; padding: 0;">';
                    trajets.forEach(trajet => {
                        // Formatage de la date selon la langue
                        const dateObj = new Date(trajet.date_trajet);
                        const dateStr = dateObj.toLocaleDateString(locale) + ' ' + dateObj.toLocaleTimeString(locale, {hour: '2-digit', minute:'2-digit'});
                        
                        // Injection HTML avec textes dynamiques
                        html += `<li style="padding: 10px; border-bottom: 1px solid #eee;">
                            <strong>${trajet.destination_nom || t('history.unknown')}</strong><br>
                            <small>üìÖ ${dateStr} | ‚è±Ô∏è ${trajet.duree} | üìè ${trajet.distance} m</small><br>
                            <small style="color:#666;">üìç ${trajet.origine || t('history.unknown')}</small>
                        </li>`;
                    });
                    html += '</ul>';
                    listContainer.innerHTML = html;
                }
                
                // --- Initialisation de la Map ---
                const map = new google.maps.Map(mapContainer, {
                    zoom: 12,
                    center: { lat: 49.1193, lng: 6.1757 }, // Centre par d√©faut (Metz)
                    mapTypeControl: false, 
                    streetViewControl: false, 
                    fullscreenControl: false
                });
                
                const bounds = new google.maps.LatLngBounds();
                const compteurVisites = {};
                
                // Compter les visites par destination
                trajets.forEach(trajet => {
                    const nom = trajet.destination_nom;
                    compteurVisites[nom] = (compteurVisites[nom] || 0) + 1;
                });
                
                const parkingsAffiches = [];
                
                trajets.forEach(trajet => {
                    // √âviter les doublons de marqueurs pour le m√™me parking
                    if (parkingsAffiches.includes(trajet.destination_nom)) return;
                    parkingsAffiches.push(trajet.destination_nom);
                    
                    const position = { lat: trajet.destination_lat, lng: trajet.destination_lng };
                    const visites = compteurVisites[trajet.destination_nom];
                    const wordVisits = t('history.visits'); // "visites" ou "visits"
                    
                    const marker = new google.maps.Marker({
                        position: position, 
                        map: map, 
                        title: trajet.destination_nom
                    });
                    
                    const infoWindow = new google.maps.InfoWindow({
                        content: `<div style="color:#333;"><strong>${trajet.destination_nom}</strong><br>${visites} ${wordVisits}</div>`
                    });
                    
                    marker.addListener('click', () => infoWindow.open(map, marker));
                    bounds.extend(position);
                });
                
                // Ajuster la carte pour tout voir s'il y a des trajets
                if (trajets.length > 0) {
                    map.fitBounds(bounds);
                }
            
            } catch (error) {
                console.error('Erreur chargement historique:', error);
                // Message d'erreur traduit
                mapContainer.innerHTML = `<p class="error" style="text-align:center; padding:50px;" data-i18n="error.history_fetch">${t('error.history_fetch')}</p>`;
                listContainer.innerHTML = '';
            }
        }
        
        loadHistorique();
    </script>
</body>
</html>